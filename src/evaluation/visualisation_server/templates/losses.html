{% extends "base.html" %}

{% block title %}Loss Curves - Nightingale{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<section class="hero">
    <h1>Loss Curves</h1>
    <p class="hero-subtitle">
        Training and Validation Loss Over Time
    </p>
</section>

<section class="losses">
    {% if loss_data %}
    <div class="controls-panel">
        <div class="control-group">
            <h3>Models to Show:</h3>
            <div class="model-checkboxes">
                {% for model in loss_data %}
                <label class="checkbox-label">
                    <input type="checkbox" id="model-{{ loop.index0 }}">
                    <span class="checkbox-text">{{ model.name }}</span>
                    <span class="model-type-badge">{{ model.model_type|upper }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="control-group">
            <h3>Curves to Show:</h3>
            <div class="curve-options">
                <label class="radio-label">
                    <input type="radio" name="curve-type" value="both" checked>
                    <span>Both Training & Validation</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="curve-type" value="train">
                    <span>Training Only</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="curve-type" value="val">
                    <span>Validation Only</span>
                </label>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="lossChart"></canvas>
    </div>

    <div class="models-list">
        <h3>Available Models:</h3>
        <ul>
            {% for model in loss_data %}
            <li>
                <span class="model-name">{{ model.name }}</span>
                <span class="model-type-badge">{{ model.model_type|upper }}</span>
                <span class="epoch-count">({{ model.epochs|length }} epochs)</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% else %}
    <div class="no-data">
        <h3>No Loss Data Found</h3>
        <p>No loss logs found in the experiment results.</p>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
{% if loss_data %}
<script>
    // Store the loss data globally
    const lossData = JSON.parse('{{ loss_data|tojson|safe }}');

    // Color palette for different models
    const colors = [
        '#e11d48', // Bright red
        '#059669', // Emerald green
        '#2563eb', // Blue
        '#dc2626', // Red
        '#7c3aed', // Purple
        '#ea580c', // Orange
        '#0891b2', // Cyan
        '#be123c', // Rose
        '#16a34a', // Green
        '#9333ea', // Violet
        '#c2410c', // Orange red
        '#0284c7', // Sky blue
        '#be185d', // Pink
        '#65a30d', // Lime
        '#7c2d12', // Brown
        '#1e40af', // Blue (darker)
        '#991b1b', // Red (darker)
        '#581c87', // Purple (darker)
        '#0f766e', // Teal
        '#a21caf'  // Fuchsia
    ];

    let chart;

    function createChart() {
        const ctx = document.getElementById('lossChart').getContext('2d');

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Training and Validation Loss Curves (Log Scale)',
                        font: {
                            family: 'Monaco, monospace',
                            size: 16
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                family: 'Monaco, monospace',
                                size: 12
                            },
                            usePointStyle: true, // Use line style in legend
                            padding: 15 // More space between legend items
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            family: 'Monaco, monospace',
                            size: 12
                        },
                        bodyFont: {
                            family: 'Monaco, monospace',
                            size: 11
                        },
                        cornerRadius: 4,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return `Epoch ${context[0].parsed.x}`;
                            },
                            label: function(context) {
                                const value = context.parsed.y;
                                let formattedValue;
                                if (value >= 1) {
                                    formattedValue = value.toFixed(2);
                                } else if (value >= 0.1) {
                                    formattedValue = value.toFixed(3);
                                } else if (value >= 0.01) {
                                    formattedValue = value.toFixed(4);
                                } else {
                                    formattedValue = value.toFixed(5);
                                }
                                return `${context.dataset.label}: ${formattedValue}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: 'Epoch',
                            font: {
                                family: 'Monaco, monospace'
                            }
                        },
                        grid: {
                            color: '#e2e8f0'
                        }
                    },
                    y: {
                        type: 'logarithmic',
                        min: 0.1,
                        max: 10,
                        title: {
                            display: true,
                            text: 'Loss (log scale)',
                            font: {
                                family: 'Monaco, monospace'
                            }
                        },
                        grid: {
                            color: '#e2e8f0'
                        },
                        ticks: {
                            font: {
                                family: 'Monaco, monospace'
                            },
                            maxTicksLimit: 8,
                            callback: function(value, index, ticks) {
                                // Clean formatting for displayed values
                                if (value >= 1) {
                                    return value.toString();
                                } else if (value >= 0.1) {
                                    return value.toFixed(1);
                                } else {
                                    return value.toFixed(2);
                                }
                            }
                        },
                        afterBuildTicks: function(axis) {
                            // Override the generated ticks with our preferred values
                            const desiredTicks = [10, 1, 0.1, 0.01];
                            axis.ticks = desiredTicks
                                .filter(tick => tick >= axis.min && tick <= axis.max)
                                .map(value => ({ value }));
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index',
                    axis: 'x'
                },
                hover: {
                    animationDuration: 200
                },
                animation: {
                    duration: 750,
                    easing: 'easeInOutQuart'
                }
            }
        });

        updateChart();
    }

    function updateChart() {
        const selectedModels = [];
        const modelCheckboxes = document.querySelectorAll('[id^="model-"]');

        modelCheckboxes.forEach((checkbox, index) => {
            if (checkbox.checked) {
                selectedModels.push(index);
            }
        });

        const curveType = document.querySelector('input[name="curve-type"]:checked').value;

        const datasets = [];

        selectedModels.forEach(modelIndex => {
            const model = lossData[modelIndex];
            const color = colors[modelIndex % colors.length];

            // Training loss - solid line with transparency
            if (curveType === 'both' || curveType === 'train') {
                datasets.push({
                    label: `${model.name} (Train)`,
                    data: model.epochs.map((epoch, i) => ({
                        x: epoch,
                        y: model.train_losses[i]
                    })),
                    borderColor: color + 'CC', // 80% opacity for training
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    pointHoverBorderWidth: 2
                });
            }

            // Validation loss - solid line, full opacity
            if (curveType === 'both' || curveType === 'val') {
                datasets.push({
                    label: `${model.name} (Val)`,
                    data: model.epochs.map((epoch, i) => ({
                        x: epoch,
                        y: model.val_losses[i]
                    })),
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 3, // Slightly thicker for validation
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    pointHoverBorderWidth: 2
                });
            }
        });

        chart.data.datasets = datasets;
        chart.update();
    }

    // Initialize chart when page loads
    document.addEventListener('DOMContentLoaded', function() {
        createChart();

        // Update chart when checkboxes or radio buttons change
        document.querySelectorAll('[id^="model-"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateChart);
        });

        document.querySelectorAll('input[name="curve-type"]').forEach(radio => {
            radio.addEventListener('change', updateChart);
        });
    });
</script>
{% endif %}
{% endblock %}
